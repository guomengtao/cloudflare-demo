<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>极简聊天</title>
    <style>
        body { font-family: sans-serif; max-width: 500px; margin: 20px auto; }
        #chat { height: 300px; border: 1px solid #ccc; overflow-y: scroll; padding: 10px; margin-bottom: 10px; background: #f9f9f9; }
        .msg { margin-bottom: 8px; border-bottom: 1px solid #eee; padding-bottom: 4px; }
        .time { font-size: 0.8em; color: #888; }
    </style>
</head>
<body>
    <h2>简易聊天室</h2>
    <input type="text" id="user" placeholder="用户名" style="width: 20%">
    <input type="text" id="text" placeholder="输入消息..." style="width: 60%">
    <button onclick="send()">发送</button>
    <div id="chat">加载中...</div>

    <script>
        const chatDiv = document.getElementById('chat');
        
        // 加载消息（包含历史和新消息）
        async function load() {
            try {
                const res = await fetch('/api/messages');
                const msgs = await res.json();
                chatDiv.innerHTML = msgs.map(m => `
                    <div class="msg">
                        <span class="time">[${new Date(m.timestamp).toLocaleTimeString()}]</span>
                        <strong>${m.username}:</strong> ${m.text}
                    </div>
                `).join('');
                // 自动滚动到底部
                chatDiv.scrollTop = chatDiv.scrollHeight;
            } catch (e) { console.error("加载失败"); }
        }

        // 发送消息
        async function send() {
            const username = document.getElementById('user').value || '匿名者';
            const text = document.getElementById('text').value;
            if (!text) return;
            
            await fetch('/api/send', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, text })
            });
            document.getElementById('text').value = '';
            load(); // 发送后立即刷新
        }

        setInterval(load, 2000); // 每2秒拉取一次，实现“伪实时”
        load(); // 初始加载
    </script>
</body>
</html>
