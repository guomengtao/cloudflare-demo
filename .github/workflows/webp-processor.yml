name: ğŸš€ WebP Data Pipeline

on:
  schedule:
    # æ¯ 30 åˆ†é’Ÿè§¦å‘ä¸€æ¬¡
    - cron: '*/30 * * * *'
  workflow_dispatch:      # å…è®¸æ‰‹åŠ¨ç‚¹å‡»æŒ‰é’®è§¦å‘ä»»åŠ¡

# æ ¸å¿ƒå®‰å…¨ï¼šç¡®ä¿åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªä»»åŠ¡åœ¨è·‘ï¼Œé¿å… TASK_WEBP è¿›åº¦è¢«å¤šä¸ªå®ä¾‹åŒæ—¶ä¿®æ”¹
concurrency:
  group: image-processing-sync
  cancel-in-progress: false

jobs:
  run-batch:
    runs-on: ubuntu-latest
    
    # å¿…é¡»å¼€å¯å˜é‡å†™æƒé™ï¼Œå¦åˆ™ gh variable set ä¼šæŠ¥ 403 é”™è¯¯
    permissions:
      contents: read
      variables: write

    steps:
      - name: â¬‡ï¸ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ğŸ“¦ Install Dependencies
        run: |
          npm install
          # ç¡®ä¿è™šæ‹Ÿæœºä¸Šæœ‰ sharp ä¾èµ–çš„åº“æˆ– webp å·¥å…·
          sudo apt-get update && sudo apt-get install -y webp

      - name: ğŸƒ Run Task Runner
        # ç¯å¢ƒå˜é‡å¯¹æ¥ï¼šè¿™é‡Œæ˜¯ä»£ç è‡ªåŠ¨è¯†åˆ« Action ç¯å¢ƒçš„å…³é”®
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          B2_ACCESS_KEY_ID: ${{ secrets.B2_ACCESS_KEY_ID }}
          B2_SECRET_ACCESS_KEY: ${{ secrets.B2_SECRET_ACCESS_KEY }}
          B2_BUCKET_NAME: "gudq-missing-assets"
          B2_ENDPOINT: "s3.us-east-005.backblazeb2.com"
          B2_REGION: "us-east-005"
          # å¦‚æœæœ‰ Cloudflare D1 ç›¸å…³çš„é…ç½®ä¹Ÿæ”¾åœ¨è¿™é‡Œ
          # CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          # CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
        run: |
          # å»ºç«‹å¿…è¦çš„ç›®å½•é˜²æ­¢è„šæœ¬æŠ¥é”™
          mkdir -p temp
          # æ‰§è¡Œä»»åŠ¡å¤„ç†å™¨ï¼šè„šæœ¬å æ‰§è¡Œæ¬¡æ•° (è¿™é‡Œè®¾ä¸º10)
          node task/task-run.js orm-run-webp.js 10

      - name: ğŸ§¹ Cleanup Workspace
        if: always() # æ— è®ºæˆåŠŸè¿˜æ˜¯ä¸­é€”å´©æºƒï¼Œéƒ½è¦æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        run: |
          rm -rf temp/*.jpg
          rm -rf temp/*.webp